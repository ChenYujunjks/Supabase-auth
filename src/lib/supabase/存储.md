âœ… **ä½ ç°åœ¨æ•´ä¸ªé‰´æƒæµç¨‹ç¡®å®æ˜¯åŸºäº SSR ä¸­çš„ `createServerClient()` + Cookie å®ç°çš„**ã€‚æˆ‘ä»¬æ¥å®Œæ•´ç¡®è®¤ä¸€ä¸‹ï¼š


## âœ… ä½ å½“å‰ Supabase é‰´æƒæµç¨‹æ¦‚è§ˆ

### ğŸ”’ ç™»å½•æµç¨‹ï¼š

ä½ ï¼ˆæˆ–æ¨¡æ¿ï¼‰ä½¿ç”¨äº† `with-supabase` é£æ ¼ï¼š

1. ç™»å½•æ—¶è°ƒç”¨ `signInWithPassword()`ï¼ˆä¸€èˆ¬åœ¨å®¢æˆ·ç«¯ï¼‰æˆ–é€šè¿‡ Edge Function ç™»å½•ï¼›
2. ç™»å½•æˆåŠŸåï¼ŒSupabase SDK **è‡ªåŠ¨å°† JWT å’Œ Refresh Token å†™å…¥ Cookie**ï¼ˆä¸æ˜¯ localStorageï¼‰ï¼›

   ```http
   Set-Cookie:
   sb-access-token=...
   sb-refresh-token=...
   ```

---

### âš™ï¸ SSR + Layout.tsxï¼š

```ts
const supabase = await createClient(); // å®é™…ä¸Šè°ƒç”¨çš„æ˜¯ createServerClient()
const { data, error } = await supabase.auth.getUser(); // ä» cookie ä¸­æ¢å¤ session
```

è¿™éƒ¨åˆ†å°±æ˜¯ SSR é‰´æƒï¼Œå®ƒä¾èµ–çš„æ˜¯ï¼š

* è¯·æ±‚ä¸­çš„ `sb-access-token` cookie
* Supabase çš„æœåŠ¡ç«¯åº“è§£å‡º `user`

âœ… ä¸ä¾èµ– localStorageï¼Œä¹Ÿä¸è¿è¡Œåœ¨æµè§ˆå™¨ï¼Œæ‰€ä»¥ localStorage æ ¹æœ¬ä¸å‚ä¸ã€‚

---

### ğŸ§  Middleware.tsï¼ˆå¦‚æœæœ‰é…ç½®ï¼‰ï¼š

```ts
export async function middleware(request: NextRequest) {
  return await updateSession(request); // è´Ÿè´£æŠŠ token å†™è¿› cookie
}
```

è¿™ä¸ªä¸­é—´ä»¶çš„ä½œç”¨æ˜¯ï¼š**ç¡®ä¿ç”¨æˆ·çš„ cookie session ä¸€ç›´åŒæ­¥å’Œæœ‰æ•ˆ**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š

* å®¢æˆ·ç«¯åˆ·æ–°é¡µé¢æ—¶ï¼Œsession ä¿¡æ¯è‡ªåŠ¨æ³¨å…¥
* SSR é¡µé¢è®¿é—®æ—¶ï¼Œcookie è‡ªåŠ¨å¯ç”¨
* æ‰€æœ‰é‰´æƒç»Ÿä¸€ä¾èµ– cookieï¼Œè€Œéæµè§ˆå™¨å­˜å‚¨

---

## âœ… æ‰€ä»¥ä½ çš„ç»“è®ºæ˜¯å¯¹çš„ï¼š

| é‰´æƒè¡Œä¸º                 | ä¾èµ–æ–¹å¼                      | æœ¬åœ°æ˜¯å¦æœ‰ localStorage             |
| -------------------- | ------------------------- | ------------------------------ |
| SSR ä¸­ `getUser()`    | âœ… Cookieï¼ˆç”± middleware è®¾ç½®ï¼‰ | âŒ ä¸ä½¿ç”¨ localStorage             |
| Client ä¸­ `getUser()` | âœ… Cookie æ³¨å…¥åå¯ç›´æ¥è§£æ         | âŒ æ²¡æœ‰æ˜¾å¼ç™»å½•å°±ä¸ä¼šå†™å…¥ localStorage     |
| æ˜¯å¦éœ€è¦ localStorageï¼Ÿ   | âŒ ä¸éœ€è¦ï¼ˆåªè¦ä½ ä¸€ç›´ç”¨ Cookie æ¨¡å¼ï¼‰   | âŒ æ­£å¸¸ä¸ä¼šå‡ºç° `supabase.auth.token` |



---


## âœ… ç­”æ¡ˆæ€»ç»“ï¼šç¡®å®ä¼šå­˜åœ¨ã€Œä¸¤ç§å­˜å‚¨æœºåˆ¶ã€å¹¶è¡Œ

| åœºæ™¯                | ä½¿ç”¨å“ªç§ Supabase Client    | å­˜å‚¨æ–¹å¼           | å­˜å‚¨ä½ç½®             |
| ----------------- | ----------------------- | -------------- | ---------------- |
| ğŸ–¥ å®¢æˆ·ç«¯æµè§ˆå™¨è®¿é—®é¡µé¢     | `createBrowserClient()` | `localStorage` | æµè§ˆå™¨å†…å­˜æŒä¹…åŒ–         |
| âš™ï¸ æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰å¤„ç†è¯·æ±‚ | `createServerClient()`  | `cookies()`    | è¯·æ±‚ä¸­çš„ HTTP cookie |

è¿™ä¸¤è€…æ˜¯**ç‹¬ç«‹è¿è¡Œçš„å­˜å‚¨æœºåˆ¶**ï¼Œäº’ä¸å¹²æ‰°ï¼Œä½†å¯ä»¥é€šè¿‡ `supabase/ssr` åŒ…ä¸­çš„ `middleware` å®ç°ã€Œå‰åç«¯ session åŒæ­¥ã€ã€‚

---

## âœ… æµç¨‹å›¾è§£ï¼šä¸€æ¬¡å®Œæ•´çš„è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ

```
ğŸ” ç”¨æˆ·åœ¨å®¢æˆ·ç«¯ç™»å½•
   â†“
ğŸ“¦ JWT è¢«è‡ªåŠ¨å­˜å…¥ localStorageï¼ˆç”± createBrowserClient å¤„ç†ï¼‰

ğŸŒ ç”¨æˆ·è®¿é—® SSR é¡µé¢ï¼ˆæˆ–åˆ·æ–°é¡µé¢ï¼‰
   â†“
ğŸ§  ä¸­é—´ä»¶ middleware.ts ä» cookie ä¸­è¯»å– JWT
   â†“
ğŸ›  createServerClient ä½¿ç”¨ cookie æ¢å¤ sessionï¼ŒéªŒè¯æƒé™
   â†“
ğŸ“¤ å“åº”é¡µé¢ï¼Œé¡µé¢åŠ è½½å®Œæˆ

ğŸ–¥ å®¢æˆ·ç«¯åŠ è½½å®Œé¡µé¢åï¼Œé‡æ–°åˆå§‹åŒ– createBrowserClient
   â†“
ğŸ“¦ localStorage ä¸­ JWT è‡ªåŠ¨ç»§ç»­ç”Ÿæ•ˆ
```

---

## âœ… æ˜¯å¦ã€Œä¸¤ä¸ªåœ°æ–¹éƒ½å­˜ã€ï¼Ÿ

æ˜¯çš„ï¼Œä½†å®ƒä»¬çš„ä½œç”¨ä¸åŒï¼š

| å­˜å‚¨             | ç”¨äºä»€ä¹ˆ             | ç”Ÿå‘½å‘¨æœŸ        | æ›¿ä»£æ€§                 |
| -------------- | ---------------- | ----------- | ------------------- |
| `localStorage` | å‰ç«¯è¯·æ±‚æ—¶æŒä¹…ä¿å­˜ç”¨æˆ·ç™»å½•    | é¡µé¢åˆ·æ–°ä¿ç•™      | âœ… å¯æ”¹ä¸º cookie        |
| `cookie`       | SSR æ—¶è¯»å– JWTï¼Œæ‰§è¡Œé‰´æƒ | HTTP è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ | âœ… é»˜è®¤ç”± middleware è®¾ç½® |

---

## âœ… å¤šå­˜æ˜¯å¦æœ‰å†²çªï¼Ÿ

ä¸ä¼šã€‚å› ä¸ºï¼š

* SSR çš„ `createServerClient()` **åªç”¨ cookie**
* å®¢æˆ·ç«¯çš„ `createBrowserClient()` **åªç”¨ localStorage**

å®ƒä»¬å„è‡ªç‹¬ç«‹ï¼Œä½†ä½ éœ€è¦ç¡®ä¿å®ƒä»¬ **åŒæ­¥ç™»å½•çŠ¶æ€**ï¼Œè€Œè¿™å°±æ˜¯ï¼š

```ts
// middleware.ts ä¸­çš„ä½œç”¨
import { updateSession } from '@supabase/ssr'

export async function middleware(request) {
  return await updateSession(request);
}
```

---

## âœ… ä½ åº”è¯¥å…³æ³¨çš„é‡ç‚¹æ˜¯ï¼š

### âœ… æ˜¯å¦ä½¿ç”¨äº† `middleware.ts` æ¥åŒæ­¥ sessionï¼Ÿ

è¿™ä¸ªæ–‡ä»¶çš„ä½œç”¨æ˜¯ï¼š

* ç”¨æˆ·ç™»å½•/ç™»å‡ºæ—¶ï¼Œæ›´æ–° cookie ä¸­çš„ JWTï¼Œç¡®ä¿ SSR æœ‰æƒé™è®¿é—®
* è‡ªåŠ¨å¤„ç† cookie <-> Supabase Server Client çš„åŒæ­¥

---

## ğŸ”§ æƒ³éªŒè¯æ˜¯å¦åŒæ­¥æˆåŠŸï¼Ÿ

ä½ å¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•ç¡®è®¤ï¼š

### 1. ç™»å½•åæ‰“å¼€æµè§ˆå™¨ `localStorage`

ç¡®è®¤æœ‰ï¼š

```
supabase.auth.token
```

### 2. æ‰“å¼€ `Application â†’ Cookies`

ç¡®è®¤æœ‰ï¼š

```
sb-access-token, sb-refresh-token
```

ï¼ˆè¿™äº›å°±æ˜¯ middleware è®¾ç½®çš„ cookieï¼Œä¾› SSR ç”¨ï¼‰

